<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan ID Card - Smart Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .camera-container {
            max-width: 600px;
            margin: 0 auto;
        }
        .camera-preview {
            border: 3px dashed #007bff;
            border-radius: 15px;
            background: #f8f9fa;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #cameraVideo {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        .upload-area {
            border: 3px dashed #28a745;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            background: #e9ecef;
            border-color: #20c997;
        }
        .upload-area.dragover {
            background: #d4edda;
            border-color: #155724;
        }
        .result-card {
            margin-top: 20px;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .processing {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-graduation-cap me-2"></i>
                Smart Attendance System
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/upload">Scan ID Card</a>
                <a class="nav-link" href="/attendance">View Records</a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div class="text-center mb-5">
            <h1 class="fw-bold text-primary">
                <i class="fas fa-qrcode me-3"></i>
                Scan ID Card
            </h1>
            <p class="lead text-muted">
                Use your camera or upload an image to scan student ID cards
            </p>
        </div>

        <!-- Tab Navigation -->
        <ul class="nav nav-pills nav-fill mb-4" id="scanTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="camera-tab" data-bs-toggle="pill" data-bs-target="#camera-panel" type="button">
                    <i class="fas fa-camera me-2"></i>
                    Camera Scan
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="pill" data-bs-target="#upload-panel" type="button">
                    <i class="fas fa-upload me-2"></i>
                    Upload Image
                </button>
            </li>
        </ul>

        <div class="tab-content" id="scanTabsContent">
            <!-- Camera Tab -->
            <div class="tab-pane fade show active" id="camera-panel">
                <div class="camera-container">
                    <div class="camera-preview" id="cameraPreview">
                        <div class="text-center">
                            <i class="fas fa-camera fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">Click "Start Camera" to begin scanning</h5>
                            <button class="btn btn-primary btn-lg mt-3" onclick="startCamera()">
                                <i class="fas fa-video me-2"></i>
                                Start Camera
                            </button>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button id="captureBtn" class="btn btn-success btn-lg me-2" onclick="captureImage()" style="display: none;">
                            <i class="fas fa-camera-retro me-2"></i>
                            Capture & Scan
                        </button>
                        <button id="stopBtn" class="btn btn-danger btn-lg" onclick="stopCamera()" style="display: none;">
                            <i class="fas fa-stop me-2"></i>
                            Stop Camera
                        </button>
                    </div>
                </div>
            </div>

            <!-- Upload Tab -->
            <div class="tab-pane fade" id="upload-panel">
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt fa-4x text-success mb-3"></i>
                    <h5>Click to upload or drag & drop</h5>
                    <p class="text-muted mb-0">
                        Supported formats: JPG, PNG, JPEG<br>
                        Max file size: 10MB
                    </p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event)">
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <h3 class="mt-5 mb-3">
                <i class="fas fa-search-plus me-2"></i>
                Scan Results
            </h3>
            <div id="resultsContainer"></div>
        </div>

        <!-- Processing Overlay -->
        <div id="processingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" style="background: rgba(0,0,0,0.7); z-index: 9999; display: none !important;">
            <div class="text-center text-white">
                <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
                <h4>Processing Image...</h4>
                <p>Detecting barcodes and validating data</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let videoStream = null;
        let videoElement = null;

        // Start camera
        async function startCamera() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment' // Use back camera on mobile
                    }
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Create video element
                videoElement = document.createElement('video');
                videoElement.id = 'cameraVideo';
                videoElement.autoplay = true;
                videoElement.playsInline = true;
                videoElement.srcObject = videoStream;

                // Replace preview content
                const preview = document.getElementById('cameraPreview');
                preview.innerHTML = '';
                preview.appendChild(videoElement);

                // Show/hide buttons
                document.getElementById('captureBtn').style.display = 'inline-block';
                document.getElementById('stopBtn').style.display = 'inline-block';

            } catch (error) {
                console.error('Error starting camera:', error);
                alert('❌ Unable to access camera. Please check permissions or try uploading an image instead.');
            }
        }

        // Stop camera
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoElement = null;

                // Reset preview
                const preview = document.getElementById('cameraPreview');
                preview.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-camera fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Click "Start Camera" to begin scanning</h5>
                        <button class="btn btn-primary btn-lg mt-3" onclick="startCamera()">
                            <i class="fas fa-video me-2"></i>
                            Start Camera
                        </button>
                    </div>
                `;

                // Hide buttons
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'none';
            }
        }

        // Capture image from camera
        function captureImage() {
            if (!videoElement) return;

            // Create canvas to capture frame
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            context.drawImage(videoElement, 0, 0);

            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Process image
            processCameraImage(imageData);
        }

        // Process camera image
        async function processCameraImage(imageData) {
            showProcessing();
            
            try {
                const response = await fetch('/api/process_camera', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Error processing image:', error);
                alert('❌ Error processing image: ' + error.message);
            } finally {
                hideProcessing();
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            if (!file.type.startsWith('image/')) {
                alert('❌ Please select a valid image file.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('❌ File size too large. Please select a file under 10MB.');
                return;
            }

            // Process file
            processUploadedFile(file);
        }

        // Process uploaded file
        async function processUploadedFile(file) {
            showProcessing();

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/api/process_image', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Error processing file:', error);
                alert('❌ Error processing file: ' + error.message);
            } finally {
                hideProcessing();
                // Reset file input
                document.getElementById('fileInput').value = '';
            }
        }

        // Display results
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const resultsContainer = document.getElementById('resultsContainer');
            
            resultsContainer.innerHTML = '';

            if (data.success && data.results && data.results.length > 0) {
                data.results.forEach((result, index) => {
                    const card = createResultCard(result, index);
                    resultsContainer.appendChild(card);
                });
                resultsSection.style.display = 'block';
            } else {
                const errorCard = document.createElement('div');
                errorCard.className = 'alert alert-warning result-card';
                errorCard.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>No Valid Barcodes Found</strong><br>
                    ${data.message || 'Please ensure the ID card is clearly visible and try again.'}
                `;
                resultsContainer.appendChild(errorCard);
                resultsSection.style.display = 'block';
            }

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Create result card
        function createResultCard(result, index) {
            const card = document.createElement('div');
            card.className = 'card result-card mb-3';
            
            const cardClass = result.valid ? 'border-success' : 'border-warning';
            const headerClass = result.valid ? 'bg-success text-white' : 'bg-warning text-dark';
            const statusIcon = result.valid ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning';
            
            card.className += ` ${cardClass}`;
            
            card.innerHTML = `
                <div class="card-header ${headerClass}">
                    <h5 class="mb-0">
                        <i class="fas ${statusIcon} me-2"></i>
                        Barcode #${index + 1} - ${result.type}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Raw Data:</strong><br><code>${result.data}</code></p>
                            ${result.reg_number ? `<p><strong>Registration Number:</strong><br><span class="badge bg-primary">${result.reg_number}</span></p>` : ''}
                            ${result.student_name ? `<p><strong>Student Name:</strong><br>${result.student_name}</p>` : ''}
                        </div>
                        <div class="col-md-6">
                            ${result.valid ? `
                                <p><strong>Attendance Status:</strong><br>
                                    <span class="badge ${result.attendance_marked ? 'bg-success' : 'bg-danger'}">
                                        ${result.attendance_marked ? '✅ Marked Successfully' : '❌ Failed to Mark'}
                                    </span>
                                </p>
                                <p><strong>Message:</strong><br>${result.message || 'No message'}</p>
                            ` : `
                                <p><strong>Validation Status:</strong><br>
                                    <span class="badge bg-warning">❌ Invalid Format</span>
                                </p>
                                <p><strong>Issue:</strong><br>${result.message || 'Invalid registration number format'}</p>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Show processing overlay
        function showProcessing() {
            document.getElementById('processingOverlay').style.display = 'flex';
        }

        // Hide processing overlay
        function hideProcessing() {
            document.getElementById('processingOverlay').style.display = 'none';
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    processUploadedFile(file);
                } else {
                    alert('❌ Please drop a valid image file.');
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                stopCamera();
            }
        });
    </script>
</body>
</html>
